{"componentChunkName":"component---src-templates-post-template-tsx","path":"/posts/next-redux-wrapper2","result":{"data":{"site":{"siteMetadata":{"title":"June"}},"markdownRemark":{"id":"91bc63cc-bc63-5de7-b532-45c0eac1093a","excerpt":"연결된 이전 포스트 : next-redux-wrapper issue with Redux-observable 1 얼마 전에 올렸던 next-redux-wrapper issue with Redux-observable…","html":"<p>연결된 이전 포스트 : <a href=\"/posts/next-redux-wrapper\">next-redux-wrapper issue with Redux-observable 1</a></p>\n<hr>\n<p>얼마 전에 올렸던 <a href=\"/posts/next-redux-wrapper\">next-redux-wrapper issue with Redux-observable</a> 포스트에 대한 해결책을 찾아\n결과를 공유하는 글을 간단~히 준비했습니다.\n(매우 짧습니다)</p>\n<hr>\n<p><a href=\"https://stackoverflow.com/questions/48950278/redux-observable-await-async-actions-and-convert-them-to-promise-using-rootepi\" target=\"_blank\" rel=\"noopener\">stackoverflow</a>를 열심히 찾다 링크와 같은 내용을 확인했습니다.</p>\n<p><code class=\"language-text\">redux-observable을 사용하면서 비동기 통신 후, dispatch에 대한 싱크가 맞지 않는다</code> 라는 문의의 답변으로 아래와 같이 <code class=\"language-text\">rootEpic에 대해 toPromise를 추가해라</code> 라는 내용이었고, saga에서의 <code class=\"language-text\">await store.sagaTask.toPromise();</code> 문구와 유사하다고 느꼈습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a02aaa34d050c8ce8fee83ea8b709eee/6b95e/stackoverflow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVQoz01Sa1PCMBDk//8zR1GglqdAAwWapA/aPNs6s16ioh92tju929m7y8Rai7IsUdU1qqoi1OBCgBcFRN0hkw6stMhKh0JWqKlG0H9JPULI2Mc5x43q+77HxHuPruugtY6slIrctS20cbhr/4DSBsYYYh3rA6KmnoBhGDDpfY8sy7BZb5CmKVbLFRhjUGTqnIWz5h8swkTuH6J2LnIINxnGESzPMVskWJLpervDbn+Atg6ORrBUZP0vf8OQwR9Ik1lIGg2t6tBkB5jiCnXNI+45Q3c9x299yx+sbxcYfoWX/BulgCcdPMwjYduATZ+Qvr1iNX3BabtGvttgO5/huEyxf0+QTp+xTxN8vC9w3m4gTwycQlyOB4jlApaMQ9JoONJu+DrFIZnjmMxQUWGbn1CzY0yqfpLp4hI56JC+u5zREhSj6e7NX8KeLiPrBg1dVdKTKOkZCGIuy6jD/nras6c6P4wRQf/Cj5/wtOtwmHDlL6AlW/ynEDkRAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"stackoverflow\"\n        title=\"stackoverflow\"\n        src=\"/static/a02aaa34d050c8ce8fee83ea8b709eee/e85cb/stackoverflow.png\"\n        srcset=\"/static/a02aaa34d050c8ce8fee83ea8b709eee/070ae/stackoverflow.png 120w,\n/static/a02aaa34d050c8ce8fee83ea8b709eee/8ff5a/stackoverflow.png 240w,\n/static/a02aaa34d050c8ce8fee83ea8b709eee/e85cb/stackoverflow.png 480w,\n/static/a02aaa34d050c8ce8fee83ea8b709eee/37523/stackoverflow.png 720w,\n/static/a02aaa34d050c8ce8fee83ea8b709eee/d9199/stackoverflow.png 960w,\n/static/a02aaa34d050c8ce8fee83ea8b709eee/6b95e/stackoverflow.png 1458w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>그래서 해당 부분을 개발 코드에 적용해 보기로 하였고, 로직 자체에 대한 레퍼런스가 없어 100퍼센트 이해하진 못하였으나, 문제가 해결되는 것을 볼 수 있었습니다.</p>\n<hr>\n<p>조금 특이하게, dispatch에 action을 넣는 방식이 아니라 각 action에 dispatch를 넣는 방식으로 돌아가는 구조였습니다.\n(이 부분에 대한 이해가 100프로가 되지 않습니다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> getServerSideProps <span class=\"token operator\">=</span> wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">getServerSideProps</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">context</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2. Page.getStaticProps uses the store to dispatch things'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/**\n   * @issue\n   * user/epics파일의 fetchUserEpic함수 return 타입을 UserEpic으로 잡으면, of()에 모든 Action을 넣으라는 에러가 나게 됨.\n   */</span>\n  <span class=\"token keyword\">const</span> initialData$ <span class=\"token operator\">=</span> <span class=\"token keyword\">of</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetchUserAction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1. toPromise를 적용할 초기 비동기 함수를 넣음</span>\n  <span class=\"token keyword\">const</span> actions <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">rootEpic</span><span class=\"token punctuation\">(</span>initialData$<span class=\"token punctuation\">,</span> rootStore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2. initialData actions에 toPromise를 적용함</span>\n  actions<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span>dispatch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 3. actions를 반복하며 dispatch를 적용함</span>\n\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'2. the end'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>기존에 올렸던 포스트의 <code class=\"language-text\">전반적인 store 세팅을 진행하는</code> store.tsx에서 달라지는 부분이 없엇고,</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// redux-saga => store.tsx</span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">SagaStore</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Store</span> <span class=\"token punctuation\">{</span>\n    sagaTask<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Task<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> makeStore<span class=\"token operator\">:</span> MakeStore<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">State</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> = (context: Context) => </span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 1: Create the middleware</span>\n    <span class=\"token keyword\">const</span> sagaMiddleware <span class=\"token operator\">=</span> <span class=\"token function\">createSagaMiddleware</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 2: Add an extra parameter for applying middleware:</span>\n    <span class=\"token keyword\">const</span> store <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> <span class=\"token function\">applyMiddleware</span><span class=\"token punctuation\">(</span>sagaMiddleware<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 3: Run your sagas on server</span>\n    <span class=\"token comment\">/*\n    * @IMPORTANT 중요한 건 이부분!!! 이 부분이 observable에 없음. 없는 그대로 진행\n    */</span>\n    <span class=\"token punctuation\">(</span>store <span class=\"token keyword\">as</span> SagaStore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>sagaTask <span class=\"token operator\">=</span> sagaMiddleware<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>rootSaga<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// 4: now return the store:</span>\n    <span class=\"token keyword\">return</span> store<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token plain-text\">;\n...</span></code></pre></div>\n<p>reducer 또한 마찬가지로, 기존 redux-saga에서와 동일하게 <code class=\"language-text\">action.type === HYDRATE</code> 구문이 추가되는 것이 동일합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// reducer.tsx</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">rootReducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span> action<span class=\"token operator\">:</span> RootActionType</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">.</span><span class=\"token keyword\">type</span> <span class=\"token operator\">===</span> <span class=\"token constant\">HYDRATE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span>action<span class=\"token punctuation\">.</span>payload\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">combinedReducer</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<hr>\n<p>해당 PoC를 진행하면서 typesafe-actions 에서 redux-toolkit을 사용하기로 결정되었기에 PoC 또한 이를 변경하는 작업을 함께 진행하였는데요! 결국 핵심적으로 바뀐 부분은 위와 같이 getInitialProps (getStaticProps, getServerSideProps) 부분이었습니다.</p>\n<p>약간의 문제로 보자면, typesafe-actions에서 redux-toolkit으로 교체하며 action들에 대한 type을 typesafe-actions 대비 redux-toolkit이 제대로 지원해주지 못하고 있습니다. (애초에 redux-thunk만 정식 지원이긴 합니다... <a href=\"https://redux-toolkit.js.org/usage/usage-with-typescript#createasyncthunk\" target=\"_blank\" rel=\"noopener\">create async thunk...</a>너무 thunk만 지원을... ㅠㅠ)</p>\n<p>결론적으로 typesafe-actions를 지우지 못하고, type을 뽑아오는 부분에서만 사용하고 있습니다. 이 부분에 대해 좋은 방법을 아시고 계신 분은 알려주시면 감사하겠습니다!! ㅎㅎ</p>","frontmatter":{"title":"next-redux-wrapper issue with Redux-observable 2","date":"January 03, 2021","tags":["javascript","next.js","redux","redux-observable","rxjs","next-redux-wrapper"]}}},"pageContext":{"slug":"/posts/next-redux-wrapper2","previous":{"fields":{"slug":"/posts/next-redux-wrapper"},"frontmatter":{"title":"next-redux-wrapper issue with Redux-observable"}},"next":{"fields":{"slug":"/posts/new-jobs2-1"},"frontmatter":{"title":"이직기 2-1"}}}},"staticQueryHashes":["1576648375","1963346411"]}